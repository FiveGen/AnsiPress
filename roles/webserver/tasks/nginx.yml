---
# Nginx is our web server of choice. Compared to Apache, it's faster with the
# same resources available, and an increasingly popular choice among sysadmins.
- name: Install nginx
  apt: name=nginx state=present update_cache=yes

- name: Remove default virtual host
  file:
    path: "/etc/nginx/sites-enabled/default"
    state: absent

- name: Install the default virtual host
  template:
    src: vhost.conf.j2
    dest: "/etc/nginx/sites-available/{{ wordpress_site_domain }}.conf"

- name: Create certificate directory
  file:
    path: "{{ ssl_direcory }}"
    state: "directory"
    owner: "{{ server_user }}"

# SSL certificate (and the key) will only be copied if you set the 'ssl'
# variable to 'true'. If you do, make sure you have all the files in place.
- name: Copy certificates into place
  synchronize:
    src: "../certs/{{ item }}"
    dest: "{{ ssl_direcory }}/{{ item }}"
  with_items:
   - "{{ ssl_key }}"
   - "{{ ssl_cert }}"
   - "{{ ssl_dhparam }}"
  when: ssl

# Copy the WordPress site's virtual host into place and reload Nginx to
# register the settings
- name: Enable new vagrant virtual host
  file:
    src: "/etc/nginx/sites-available/{{ wordpress_site_domain }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ wordpress_site_domain }}.conf"
    state: link
  notify:
    - reload nginx
